<div class="graph-node flex flex-col items-center gap-1 cursor-pointer" (click)="onNodeClick($event, node.id)" cdkOverlayOrigin
    #parentTrigger="cdkOverlayOrigin">
    <div class="rounded-full flex justify-center items-center w-10 h-10 relative"
        [ngStyle]="{ 'background-color': node.iconBackgroundColor }">
        <mat-icon [ngStyle]="{ 'color': node.iconColor }">storage</mat-icon>
        @if(node.badgeType){
        <mat-icon class="!text-purple-700 absolute -top-2 -right-2">account_circle</mat-icon>
        }
    </div>
    <p class="text-gray-700 font-semibold text-sm">{{ node.name }}</p>
</div>

@if(node.children.length > 0){
<img src="/assets/images/arrow.png" width="100px">
}

<ng-template 
    cdkConnectedOverlay
    [cdkConnectedOverlayOrigin]="parentTrigger"
    [cdkConnectedOverlayOpen]="openPopoverId === node.id"
    (backdropClick)="closePopover()"
    (detach)="closePopover()"
    [cdkConnectedOverlayPositions]="positions"
    [cdkConnectedOverlayFlexibleDimensions]="true"
    [cdkConnectedOverlayPush]="true"
>
    @if(node.type === 'vulnerability'){
    <app-vulnerabilities-drawer></app-vulnerabilities-drawer>
    }
    @else if(node.type === 'fix'){
    <app-fix-drawer></app-fix-drawer>
    }
    @else if(node.type === 'action'){
    <app-action-drawer></app-action-drawer>
    }
</ng-template>

<div class="flex flex-col gap-4">
    @if (node.children.length > 0) {
    @for (child of node.children; track child.id) {
    <div class="flex flex-col items-center gap-1 cursor-pointer" (click)="onNodeClick($event, child.id)"
        cdkOverlayOrigin #childTrigger="cdkOverlayOrigin">
        <div class="bg-[#D7EAFF] rounded-full flex justify-center items-center w-10 h-10 relative">
            <mat-icon class="!text-[#1774DE]">storage</mat-icon>
            @if(child.badgeType){
            <mat-icon class="!text-red-700 absolute -top-2 -right-2">gpp_bad</mat-icon>
            }
        </div>
        <p class="text-gray-700 font-semibold text-sm">{{ child.name }}</p>
        <p class="text-gray-500 text-xs">{{ child.ipAddress }}</p>
    </div>

    <ng-template 
        cdkConnectedOverlay
        [cdkConnectedOverlayOrigin]="parentTrigger"
        [cdkConnectedOverlayOpen]="openPopoverId === child.id"
        (backdropClick)="closePopover()"
        (detach)="closePopover()"
        [cdkConnectedOverlayPositions]="positions"
        [cdkConnectedOverlayFlexibleDimensions]="true"
        [cdkConnectedOverlayPush]="true"
    >
        @if(child.type === 'vulnerability'){
        <app-vulnerabilities-drawer></app-vulnerabilities-drawer>
        }
        @else if(child.type === 'fix'){
        <app-fix-drawer></app-fix-drawer>
        }
        @else if(child.type === 'action'){
        <app-action-drawer></app-action-drawer>
        }
    </ng-template>
    }
    }

</div>